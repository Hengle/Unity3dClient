--打开登陆界面
local frame = nil
local LoginFrame = {}
local json = require(".utility.json")
local util = require(".utility.util")
local web = require(".net.web")
LOGIN_SERVER = { ip="192.168.0.100", port=6001 }

--点击登陆按钮
local OnClickLogin = function()

	local account = frame:GetObject('account').text
	local password = frame:GetObject('password').text
	CS.UnityEngine.Debug.LogError('account = ' .. account .. ' password = ' .. password)
	
	local err = LoginFrame:checkLoginInput(account,password)
	if err then
		CS.UnityEngine.Debug.LogError('chekLoginInput unValid !' .. err.err_code)
		return
	end
	
	--准备登陆
	LoginFrame:login({
            channel = 'game',
            account = account, 
            password = password,
        })
		
	--[[
	local hasAccount = true
	if hasAccount then
		CS.GameClient.UIFrameLua.OpenFrameLua(3)
	else
		CS.UnityEngine.Debug.LogError('has no Account Register !!!')
	end]]
end

function OnOpenFrame(x)
	--添加点击登陆安扭事件
	frame = x
	x = nil
	
	frame:GetObject('account').text = 'DingJiaMing'
	frame:GetObject('password').text = '123456'
	
	frame:GetObject('btnLogin').onClick:AddListener(OnClickLogin)
end

function OnCloseFrame(x)
	frame = nil
end

function LoginFrame:checkLoginInput(account, password)
    local err
		if not account or #account == 0 then
			err = { err_code = 'account_nil' }
		elseif #account < 6 or #account > 20 or string.find(account, "[%W]") then
			err = { err_code = 'account_error' }
		elseif not password or #password == 0 then
			err = { err_code = 'password_nil' }
		elseif #password < 6 or #password > 20 or string.find(password, "[%W]") then
			err = { err_code = 'password_error' }
		end
    return err
end

function LoginFrame:login(params)
	CS.UnityEngine.Debug.LogError('ready to login !!!')
	params.cmd = "login"
	params.reg_id = ""
	LoginFrame:auth(params)
end

function LoginFrame:auth(params)
	CS.UnityEngine.Debug.LogError('ready to auth !!!')
	function loginCallback(ok, msg)
		print(ok)
		print(msg)
	end
	LoginFrame:serverTimeAndPack(loginCallback,params)
end

function LoginFrame:serverTimeAndPack(callback, params)
	CS.UnityEngine.Debug.LogError('ready to auth serverTimeAndPack!!!')
    web.getServerTime(function (time)
        if time <= 0 then
        	callback(false,"time over")
            return
        end

        params.client_tag = "test_clt_tag"
        params.platform = "test_pf"

        local msg = json.encode(params)
        msg = CS.Common.DESEncrypt.MyEncode(msg, time)
        msg = util.tohex(msg)

        LoginFrame:FinalAuth(callback, time, msg, params)
    end)
end

function loginCallback(ok, msg)
    print(ok)
    print(msg)
    --print("loginCallback,ok:"..ok.."msg:"..msg)
end

function LoginFrame:FinalAuth(callback, time, msg, params)
    local postdata = {
        time = tostring(time),
        content = msg,
    }

    print(LOGIN_SERVER,"/login","POST",postdata)
    web.httpRequest(callback,LOGIN_SERVER, "/login", "POST", postdata)
end