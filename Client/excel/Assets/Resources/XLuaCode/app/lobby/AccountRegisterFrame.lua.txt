---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by asus.
--- DateTime: 2018/4/9 17:23
---
local web = require('.net.web')
local json=require('.utils.JsonUtils')
local numeric=require('.utils.NumericUtils')

local AccountRegisterFrame = {}

function AccountRegisterFrame.OnOpenFrame()
    self.frame:GetObject('btn_close').onClick:AddListener(AccountRegisterFrame.onClickClose)
    self.frame:GetObject('btn_register').onClick:AddListener(AccountRegisterFrame.onClickRegister)
    self.frame:GetObject('btn_get_verify_code').onClick:AddListener(AccountRegisterFrame.onClickGetVerifyCode)
end

AccountRegisterFrame.onClickClose = function()
    app.FrameManager.CloseFrame(self.frame)
end

AccountRegisterFrame.onClickRegister = function()
    local phoneNumber = self.frame:GetObject("txt_phone_number").text
    local password = self.frame:GetObject("txt_password").text
    local passwordRepeat = self.frame:GetObject("txt_password_repeat").text
    local verifyCode = self.frame:GetObject("txt_verify_code").text

    if DEVELOPMENT then
        phoneNumber = '13867486002'
        password = 'il15958589125'
        passwordRepeat = password
        app.Debugger.LogError(phoneNumber)
        app.Debugger.LogError(password)
        app.Debugger.LogError(passwordRepeat)
        app.Debugger.LogError(verifyCode)
    end

    local err = self:checkRegisterInput(phoneNumber, password, passwordRepeat, verifyCode)

    if err then
        app.Debugger.Log('error=' .. err)
        return
    end

    self:auth({
        cmd = "register",
        channel = "game",
        account = phoneNumber,
        password = password,
        --invite_code = verifyCode,
        phone = phoneNumber,
        reg_code = verifyCode,
        reg_id = ""
    })
end

function AccountRegisterFrame:checkRegisterInput(account, password, passwordRepeat, verifyCode)
    local err
    if not account or #account == 0 then
        err = app._ErrorCode.account_nil
    elseif #account < 6 or #account > 20 or string.find(account, "[%W%.%-_]") then
        err = app._ErrorCode.account_error
    elseif not password or #password == 0 then
        err = app._ErrorCode.password_nil
    elseif #password < 6 or #password > 20 or string.find(password, "[%W%.%-_]") then
        err = app._ErrorCode.password_error
    elseif password ~= passwordRepeat then
        err = app._ErrorCode.password_repeat_error
    elseif verifyCode and (#verifyCode == 0 or #verifyCode > 6) then
        err = app._ErrorCode.reg_code_error
    end
    return err
end

function AccountRegisterFrame:auth(params)
    local function loginCallback(err,res)
        if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
            app.Debugger.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
        else
            app.Debugger.LogError('['..tostring(err)..']:'..res)
        end
    end

    local function getServerTimeCallback(err,res)
        if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
            app.Debugger.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
            --登陆服务器
            params.client_tag = tostring(CLIENT_TAG)
            params.platform = 'android'
            local msg = json.encode(params)
            --regMsg = CS.Common.DESEncrypt.MyEncode(regMsg,msg)
            --regMsg = numeric.tohex(regMsg)
            local postValues =
            {
                time = res,
                content = msg,
            }
            local postStr = web.ToPostData(postValues)
            print("HTTP postStr"..postStr)

            web.httpRequest(loginCallback,LOGIN_SERVER, "/login", "POST", postStr)
        else
            app.Debugger.LogError('['..tostring(err)..']:'..res)
        end
    end

    --拉取服务器时间
    web.getServerTime(getServerTimeCallback,LOGIN_SERVER)
end

AccountRegisterFrame.onClickGetVerifyCode = function()
    --TODO 获取验证码逻辑实现
end

function AccountRegisterFrame.OnCloseFrame()
end

-- ----------------------------------------控制代码--------------------------------------------------

return AccountRegisterFrame