---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by asus.
--- DateTime: 2018/4/9 17:23
---
local web = require('.net.web')
local json=require('.utils.JsonUtils')
local numeric=require('.utils.NumericUtils')

local AccountRegisterFrame = {}

function AccountRegisterFrame.OnOpenFrame()
    self.frame:GetObject("btnRegister").onClick:AddListener(AccountRegisterFrame.onClickRegister)
    self.frame:GetObject("btnClose").onClick:AddListener(AccountRegisterFrame.onClickClose)
    self.frame:GetObject("btnGetVerifyCode").onClick:AddListener(AccountRegisterFrame.onClickGetVerifyCode)
end

AccountRegisterFrame.onClickClose = function()
    app.FrameManager.CloseFrame(self.frame)
end

AccountRegisterFrame.onClickRegister = function()
    --TODO 注册逻辑实现
    local phone = self.frame:GetObject("phoneNumber").text
    local password = self.frame:GetObject("password").text
    local repeat_password = self.frame:GetObject("repeat_password").text
    local verifyCode = self.frame:GetObject("verifyCode").text

    if DEVELOPMENT then
        phone = '13867486002'
        password = 'il15958589125'
        repeat_password = password
        CS.UnityEngine.Debug.LogError(phone)
        CS.UnityEngine.Debug.LogError(password)
        CS.UnityEngine.Debug.LogError(repeat_password)
        CS.UnityEngine.Debug.LogError(verifyCode)
    end

    local err = self:checkRegisterInput(phone, password, verifyCode)

    if err then
        CS.UnityEngine.Debug.Log('error=' .. err)
        return
    end

    self:auth({
        cmd = "register",
        channel = "game",
        account = phone,
        password = password,
        --invite_code = verifyCode,
        phone = phone,
        reg_code = verifyCode,
        reg_id = ""
    })
end

function AccountRegisterFrame:checkRegisterInput(account, password, inviteCode)
    local err
    if not account or #account == 0 then
        err = app._ErrorCode.account_nil
    elseif #account < 6 or #account > 20 or string.find(account, "[%W]") then
        err = app._ErrorCode.account_error
    elseif not password or #password == 0 then
        err = app._ErrorCode.password_nil
    elseif #password < 6 or #password > 20 or string.find(password, "[%W]") then
        err = app._ErrorCode.password_error
        --[[
    elseif inviteCode and (#inviteCode == 0 or #inviteCode > 10) then
        err = app._ErrorCode.invite_error
        --]]
    end
    return err
end

function AccountRegisterFrame:auth(params)
    local function loginCallback(err,res)
        if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
            CS.UnityEngine.Debug.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
        else
            CS.UnityEngine.Debug.LogError('['..tostring(err)..']:'..res)
        end
    end

    local function getServerTimeCallback(err,res)
        if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
            CS.UnityEngine.Debug.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
            --登陆服务器
            params.client_tag = tostring(CLIENT_TAG)
            params.platform = 'android'
            local msg = json.encode(params)
            --regMsg = CS.Common.DESEncrypt.MyEncode(regMsg,msg)
            --regMsg = numeric.tohex(regMsg)
            local postValues =
            {
                time = res,
                content = msg,
            }
            local postStr = web.ToPostData(postValues)
            print("HTTP postStr"..postStr)

            web.httpRequest(loginCallback,LOGIN_SERVER, "/login", "POST", postStr)
        else
            CS.UnityEngine.Debug.LogError('['..tostring(err)..']:'..res)
        end
    end

    --拉取服务器时间
    web.getServerTime(getServerTimeCallback,LOGIN_SERVER)
end

AccountRegisterFrame.onClickGetVerifyCode = function()
    --TODO 获取验证码逻辑实现
end

function AccountRegisterFrame.OnCloseFrame()

end

return AccountRegisterFrame