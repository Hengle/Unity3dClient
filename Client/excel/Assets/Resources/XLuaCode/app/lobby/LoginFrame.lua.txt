--打开登陆界面
local LoginFrame = {}

local json = app.util.JsonUtils
local util = app.util.NumericUtils
local web = require(".net.web")

function LoginFrame.OnOpenFrame()
	self.frame:GetObject('account').text = 'DingJiaMing'
	self.frame:GetObject('password').text = '123456'
	-- 添加按钮事件
	self.frame:GetObject('btnLogin').onClick:AddListener(LoginFrame.OnClickLogin)
	self.frame:GetObject("btnChangeAccount").onClick:AddListener(LoginFrame.onClickChangeAccount)
end

-- 按钮事件回调 局部变量且不写入元表
LoginFrame.onClickChangeAccount = function()
	app.FrameManager.OpenFrameLua(app._FrameList.AccSelectFrame)
end

--点击登陆按钮
LoginFrame.OnClickLogin = function()
	--CS.GameClient.MessageBoxFrame.Open(function() print('ok') end,function() print('cancel') end,1)
	local loginParam =
	{
		cmd = "login",
		channel = "game",
		account = '13867486001',
		password = 'il15958589125',
		--invite_code = verifyCode,
		--phone = '13867486001',
		--reg_code = verifyCode,
		--reg_id = ""
	}

	self:auth(loginParam)
end

function LoginFrame.OnCloseFrame()

end

function LoginFrame.loginCallback(err,res)
	if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
		CS.UnityEngine.Debug.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
	else
		CS.UnityEngine.Debug.LogError('['..tostring(err)..']:'..res)
	end
end

function LoginFrame:auth(params)
	local function getServerTimeCallback(err,res)
		if CS.NetWork.HttpRequestError.HRE_SUCCEED == err then
			CS.UnityEngine.Debug.Log('<color=#00ff00>['..tostring(err)..']:'..res..'</color>')
			--登陆服务器
			params.client_tag = tostring(CLIENT_TAG)
			params.platform = 'android'
			local msg = json.encode(params)
			--regMsg = CS.Common.DESEncrypt.MyEncode(regMsg,msg)
			--regMsg = numeric.tohex(regMsg)

			local postValues =
			{
				time = res,
				content = msg,
			}
			local postStr = web.ToPostData(postValues)
			print("HTTP postStr"..postStr)
			web.httpRequest(self.loginCallback, LOGIN_SERVER, "/login", "POST", postStr)
		else
			CS.UnityEngine.Debug.LogError('['..tostring(err)..']:'..res)
		end
	end

	--拉取服务器时间
	web.getServerTime(getServerTimeCallback,LOGIN_SERVER)
end

return LoginFrame